#Libraries for PCA
library(ggbiplot)
library(psych) 

#open directory for data
setwd("~/Dropbox/Desktop/LinkNE_paper_data/Enviro/")

#All environmental data
env_data=read.table("Combined_Sites_EnviroAnthro_DATA_FINAL_updateFeb2019_wc2_SST_meanPopdensity.txt", header=T)
head(env_data)
env_data$Log_pop_density=log10(env_data$pop_density_2000_results+1) #Add log+1 for population density measures

#Check top 10 factors for random forest - then subset these from file
results=read.table("RandomForest/NorthAM_RF_results/meanMDA_northam_Feb2019.txt", header=T)
results$env=rownames(results)
results[order(results$rowMeans.MDA., decreasing = T),]

######### Select all top 10 variables- or top + variables (do not include ones with negative MDA)
#All environmental variables - will keep anthropogenic variables seperate for analysis later
tempprec_pop_PCs_=env_data[,c("Code","group",
                              "Bio7_TempAnnRange",
                              "Bio6_MinTempColdestM",
                              "Bio17_PrecDriestQ",
                              "Bio12_AnnPrecip",  
                              "Bio4_TempSeasonality")]

#Subset for North American
tempprec_pop_PCs_north=tempprec_pop_PCs_[which(tempprec_pop_PCs_$group=="NorthAM"),]
dim(tempprec_pop_PCs_north)

#Check correlations for all 10 vairables
#pairs.panels(tempprec_pop_PCs_north[,c(3:11,13)], scale=T)
pairs.panels(tempprec_pop_PCs_north[,c(3:ncol(tempprec_pop_PCs_north))], scale=T)
hist(tempprec_pop_PCs_north$Bio6_MinTempColdestM)
hist(tempprec_pop_PCs_north$Bio12_AnnPrecip)
hist(tempprec_pop_PCs_north$Bio17_PrecDriestQ)
hist(tempprec_pop_PCs_north$Bio7_TempAnnRange)
hist(tempprec_pop_PCs_north$Bio4_TempSeasonality)

#Run PCA on top environmental data
tempprec.pca_na_pop<- prcomp(tempprec_pop_PCs_north[,c(3:ncol(tempprec_pop_PCs_north))],
                             center = T,
                             scale = T) 
summary(tempprec.pca_na_pop) #PCA summary

#Try PCA plots
nort_env=env_data[which(env_data$group=="NorthAM"),]
#Make sure SGR and MGR are coded correctly (updated in revisions)
nort_env$Significance[which(nort_env$Code=="SGR")]<-"NoChange"
nort_env$Significance[which(nort_env$Code=="MGR")]<-"NoChange"

significance.grp <- nort_env[, "Significance"]

g <- ggbiplot(tempprec.pca_na_pop, 
              choice= c(1,3),  
              groups = significance.grp)
g <- g + scale_color_manual( values=c("dodgerblue4", "firebrick1"), name = '')
g <- g +theme_bw()+ theme(legend.direction = 'horizontal', 
                          legend.position = 'top', panel.grid = element_blank()) 
print(g)

North_Am_plot <-g

#Get PC data
tempprec.pca_na_pop_results=as.data.frame(tempprec.pca_na_pop$x)


#Merge Pop names with PC axes resuslts
PC_temps_prec_northam_pop=as.data.frame(cbind(tempprec_pop_PCs_north[,1:2],tempprec.pca_na_pop_results[,1:3]))
colnames(PC_temps_prec_northam_pop)=c("Pop", "Group", "PC1_bios_lat", "PC2_bios_lat","PC3_bios_lat")

rf_top10_northam_tempPrec_pop_merge=as.data.frame(cbind(PC_temps_prec_northam_pop, significance.grp))

write.table(rf_top10_northam_tempPrec_pop_merge,"RandomForest/NorthAM_RF_results/PCA/NorthAM_topPOSITIVE_Variables_3PCs_Feb2019.txt",
            quote=F, row.names = F, col.names = T, sep="\t")

#PC 1 -- #Cold temps -> Bio6 
barplot(abs(tempprec.pca_na_pop$rotation[,1])) #Cold temps -> Bio6 and Bio12 are top (along with precipitation BIO14 and BIO12)
par(mar=c(5,5,5,5))
barplot((tempprec.pca_na_pop$rotation[,1]))


##PC 2 #Bio7_TempAnnRange 
barplot(abs(tempprec.pca_na_pop$rotation[,2]))  #Temp range (Bio7)
barplot((tempprec.pca_na_pop$rotation[,2]))  #

#PC 3 # top variable SST max
barplot(abs(tempprec.pca_na_pop$rotation[,3])) #SST
barplot((tempprec.pca_na_pop$rotation[,3]))

all_salmon_data=read.table("Combined_Sites_EnviroAnthro_DATA_FINAL_updateFeb2019_wc2_SST_meanPopdensity.txt", header=T)
north_am_data=all_salmon_data[which(all_salmon_data$group=="NorthAM"),]
north_am_data$Significance[which(north_am_data$Code=="SGR")]<-"NoChange"
north_am_data$Significance[which(north_am_data$Code=="MGR")]<-"NoChange"

ggplot(north_am_data, aes(x=Significance, y=(log10(averagepress))))+
  geom_boxplot(outlier.colour = "white", varwidth = 1)+
  geom_jitter(width = 0.1, height = 0, alpha=0.5, size=5)+
  theme_bw()+theme(panel.grid = element_blank())

ggplot(north_am_data, aes(x=Significance, y=(BO2_templtmax_ss)))+
  geom_boxplot(outlier.colour = "white", varwidth = 1)+
  geom_jitter(width = 0.1, height = 0, alpha=0.5, size=5)+
  theme_bw()+theme(panel.grid = element_blank()  )

ggplot(north_am_data, aes(x=Significance, y=(Bio12_AnnPrecip)))+
  geom_boxplot(outlier.colour = "white", varwidth = 1)+
  geom_jitter(width = 0.1, height = 0, alpha=0.5, size=5)+
  theme_bw()+theme(panel.grid = element_blank()  )

ggplot(north_am_data, aes(x=Significance, y=(Bio4_TempSeasonality)))+
  geom_boxplot(outlier.colour = "white", varwidth = 1)+
  geom_jitter(width = 0.1, height = 0, alpha=0.5, size=5)+
  theme_bw()+theme(panel.grid = element_blank()  )

wilcox.test(log10(north_am_data$averagepress)~north_am_data$Significance)

wilcox.test((north_am_data$BO2_templtmax_ss)~north_am_data$Significance)
wilcox.test((north_am_data$Bio6_MinTempColdestM)~north_am_data$Significance)
wilcox.test((north_am_data$Bio7_TempAnnRange)~north_am_data$Significance)
wilcox.test((north_am_data$Bio4_TempSeasonality)~north_am_data$Significance)
wilcox.test((north_am_data$Bio17_PrecDriestQ)~north_am_data$Significance)
wilcox.test((log10(north_am_data$pop_density_2000_results+1))~north_am_data$Significance)

plot(north_am_data$Bio17_PrecDriestQ,north_am_data$Bio6_MinTempColdestM)

View(north_am_data)
ggplot(north_am_data[which(north_am_data$Code!="GAR" & north_am_data$Code!="BDN"),], aes(x=Significance, y=(log10(averagepress))))+
  geom_boxplot(outlier.colour = "white", varwidth = 1)+
  geom_jitter(width = 0.1, height = 0, alpha=0.5, size=5)+
  theme_bw()+theme(panel.grid = element_blank())

