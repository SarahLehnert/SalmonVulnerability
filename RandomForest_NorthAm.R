library(randomForest)

#Set directory
setwd("~/Dropbox/Desktop/LinkNE_paper_data/Enviro/")

#Read in environmental data
env<-read.table("Combined_Sites_EnviroAnthro_DATA_FINAL_updateFeb2019_wc2_SST_meanPopdensity.txt", header=T)
head(env)
rownames(env)<-env[,1] #Change row name to Pop ID
env=env[which(env$group=="NorthAM"),] #Use only North American populations

#Transform variables
env$Log_Aqua=log10(env$averagepress) #Add log value for aquqculuture pressure
env$Log_pop_density=log10(env$pop_density_2000_results+1) #Add log+1 for population density measures
hist(env$Log_pop_density)
dim(env) #Make sure there are 73 pop for North America
str(env)

#25 measures (predictors for environmental/anthropogenic influence)
#Subset these variables
env2<-env[,c(5:24, 64, 70:73)] #Enviro variables: Latitude, Bio1-19, MEAN_Anomalies_1975_2005, Long term SST max, Mean SST  (May, June, July), Log Aqua, Log density
ncol(env2)
str(env2)

#Create response variable (Signficance-> decline or no decline)
phenos<-as.data.frame(env[,("Significance")])
colnames(phenos)="Decline"
phenos$Decline=as.character(phenos$Decline)

#Add row names to "response"
rownames(phenos)<-env[,1]
str(phenos)
phenos$Decline=as.factor(as.character(phenos$Decline))
str(phenos)


#Scale environmental variables 
scaleenv<-as.data.frame(apply(env2[,1:ncol(env2)], 2, function(x) scale(x)))
rownames(scaleenv)<-rownames(env)

#Create data for MDA
MDA<-as.data.frame(matrix(nrow=25, ncol=ncol(phenos)))
colnames(MDA)<-colnames(phenos)

length(phenos[which(phenos$Decline==1),])
length(phenos[which(phenos$Decline==0),])

#Create data for MSE
nrow(phenos)
MSE<-as.data.frame(matrix(nrow=73, ncol=ncol(phenos)))
colnames(MSE)<-colnames(phenos)
rownames(MSE)<-rownames(phenos)

#Make sure MGR and SGR are correctly assigned/labelled (updated after revisions)
phenos[which(rownames(phenos)=="SGR"),]<-"NoChange"
phenos[which(rownames(phenos)=="MGR"),]<-"NoChange"

#View(scaleenv)
tuneRF(scaleenv, phenos[,1]) ##for selecting mtry parameter. Good to do for each rf model.

#Change sample size so they are equal in analysis
table(phenos[,1]) ## For determining sampsize for downsampling. should be very close to BMIGtest

#Run Random Forest Analysis
set.seed(88)
rf<-randomForest(scaleenv,phenos[,1], ntree=10000, mtry=10, importance=TRUE, sampsize = c(29,29), strata=phenos[,1], do.trace = 500)

#Get importance for each variable (MDA info)
MDA[,1]<-as.data.frame(randomForest::importance(rf, type=1))
predict(rf, type="prob")
rownames(MDA)<-rownames(rf$importance)
rf$importance
MeanMDA<-as.data.frame(rowMeans(MDA))
MeanMDA$type=rownames(MeanMDA)
MeanMDA[order(MeanMDA$`rowMeans(MDA)`, decreasing = T),]
#plot loadings
barplot(MeanMDA$`rowMeans(MDA)`, names.arg =rownames(MeanMDA), las=2)

#Save new data 
write.table(MeanMDA, file="RandomForest/NorthAM_RF_results/meanMDA_northam_Feb2019.txt", sep="\t", row.names=TRUE, col.names=TRUE, quote=FALSE)

#Read in again and plot 
MDA_data=read.table("RandomForest/NorthAM_RF_results/meanMDA_northam_Feb2019.txt", header=T)
MDA_data$Measure<-rownames(MDA_data)
colnames(MDA_data)=c("MDA", "Measure")
MDA_data$order=c(1:25)
library(ggplot2)

#Plot to see (use other script for nice plots with European data)
ggplot(data=MDA_data, aes(x=reorder(Measure, order),y=(MDA)))+geom_bar(stat="identity")+#facet_grid(.~Variable)+
  theme_bw()+#scale_y_continuous(lim=c(0,15),expand = c(0, 0))+
  #geom_hline(yintercept =1)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, size = 15),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+ylab("MDA")+ xlab("Environmental variable")



