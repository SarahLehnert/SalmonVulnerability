setwd("~/Desktop/Sarah/Salmon/GenomicVulnerability/")
library(rbioclim)
library(rgdal)
library(raster)
library(data.table)
library(tidyr)

#Get environmental data from bioclim for all time periods
bioclim = recursive.getData(times="all") # by default resolution 2.5m and the 19 bioclim variables. (but can be changed)

#Bioclim variables of interest: 
#Get enviro data for each future RCP scenario 
future_26=(bioclim[["CC2650"]])
bio_rcp26=future_26[[c("bio2", "bio8", "bio10",
                       "bio11", "bio13", "bio15")]]

future_45=(bioclim[["CC4550"]])
bio_rcp45=future_45[[c("bio2", "bio8", "bio10",
                       "bio11", "bio13", "bio15")]]

future_60=(bioclim[["CC6050"]])
bio_rcp60=future_60[[c("bio2", "bio8", "bio10",
                       "bio11", "bio13", "bio15")]]

future_85=(bioclim[["CC8550"]])
bio_rcp85=future_85[[c("bio2", "bio8", "bio10",
                       "bio11", "bio13", "bio15")]]

bioclim = recursive.getData(times="pres") # by default resolution 2.5m and the 19 bioclim variables. (but can be changed)
present=(bioclim[["pres"]])
bio_present=present[[c("bio2", "bio8", "bio10",
                       "bio11", "bio13", "bio15")]]

#Read site info - to get coordinates for extracting enviro data for all salmon rivers in North America (NASCO database)
northam=read.csv("~/Desktop/Sarah/Salmon/COSEWIC/NASCO_status_all_rivers.csv", header=T)
head(northam)
table(northam$Nasco)

#Remove pops that have been lost already (extirpated)
northam_present<- northam[which(northam$Nasco!="LOST"),]

#Set coordinates to get data for
coordinates=cbind(northam_present$Long.1, northam_present$Lat)

#Extract datasets for all sites with genomic data
bio_rcp26_future<- raster::extract(bio_rcp26, coordinates)
bio_rcp45_future<- raster::extract(bio_rcp45, coordinates)
bio_rcp60_future<- raster::extract(bio_rcp60, coordinates)
bio_rcp85_future<- raster::extract(bio_rcp85, coordinates)
bio_present_data <- raster::extract(bio_present, coordinates)


#Merge with Pop names (Code)
rcp26_save=as.data.frame(cbind(as.character(northam_present$Rivername), bio_rcp26_future))
rcp45_save=as.data.frame(cbind(as.character(northam_present$Rivername), bio_rcp45_future))
rcp60_save=as.data.frame(cbind(as.character(northam_present$Rivername), bio_rcp60_future))
rcp85_save=as.data.frame(cbind(as.character(northam_present$Rivername), bio_rcp85_future))
present_save=as.data.frame(cbind(as.character(northam_present$Rivername), bio_present_data))

#note a few rivers are missing - but can just exclude
present_save[is.na(present_save$bio8),]
nrow(present_save[!is.na(present_save$bio8),]) #934 rivers with data... 

#Save files for gradient forest
write.table(rcp26_save[!is.na(rcp26_save$bio2),], "GradientForest_AllSalmonRivers/RCP26_future_selectEnviro.txt", quote=F, row.names = F, col.names = T, sep="\t")
write.table(rcp45_save[!is.na(rcp45_save$bio2),], "GradientForest_AllSalmonRivers/RCP45_future_selectEnviro.txt", quote=F, row.names = F, col.names = T, sep="\t")
write.table(rcp60_save[!is.na(rcp60_save$bio2),], "GradientForest_AllSalmonRivers/RCP60_future_selectEnviro.txt", quote=F, row.names = F, col.names = T, sep="\t")
write.table(rcp85_save[!is.na(rcp85_save$bio2),], "GradientForest_AllSalmonRivers/RCP85_future_selectEnviro.txt", quote=F, row.names = F, col.names = T, sep="\t")
write.table(present_save[!is.na(present_save$bio2),], "GradientForest_AllSalmonRivers/present_selectEnviro.txt", quote=F, row.names = F, col.names = T, sep="\t")

