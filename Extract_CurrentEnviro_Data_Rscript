##Extracting environmental data

setwd("~/Desktop/Sarah/Salmon/GenomicVulnerability/")
library(raster)
library(rbioclim)
library(rgdal)
library(raster)
library(data.table)
library(tidyr)
library(psych)

#Get allele frequency data
all_snps=fread("Combined_CAN_goodSNPs_allruns_badindremove_94K_updateIDs2_final_3838ind_maf005_recode_AlleleFrequencies.frq.strat", header=T)
all_snps_allelefreq=spread(all_snps[,c(2,3,6)], "SNP", "MAF")
dim(all_snps_allelefreq)

#Get bioclim data - for present
bioclim = recursive.getData(times="pres") # by default resolution 2.5m and the 19 bioclim variables. (but can be changed)
present_bioclim <- bioclim[["pres"]]

#Extract data for Bio 1-19
bio_present <- present_bioclim[[paste0("bio",c(1:19))]]

##Site locations
northam=read.csv("SiteInfo/All_siteLocations_NorthAmerican_UPDATED.csv", header=T)
head(northam)

#Merge site locations with SNP data (include a few things for site location info lat/long)
all_data=merge(northam[,c(1:3,6)], as.data.frame(all_snps_allelefreq),  by=1)
all_data[1:10,1:10]
dim(all_data)

#change ARO -- location does not appear to be on land where Bioclim data is present
all_data$Long[which(all_data$Code=="ARO")] <- -66.93775
all_data$Lat[which(all_data$Code=="ARO")] <- 50.07073

#change LSR -- almost in ocean
all_data$Lat[which(all_data$Code=="LSR")] <- all_data$Lat[which(all_data$Code=="LSR")]+0.01


#Create coordinate dataframe
coordinates=cbind(all_data$Long, all_data$Lat)

#Get bioclim data for site coordinates
bioclim_all_sites_present <- raster::extract(bio_present, coordinates)
#Combine bioclim data with Site codes
bioclim_all_sites_present_info <- as.data.frame(cbind(as.character(all_data$Code), bioclim_all_sites_present))

#Check for NAs -- may need to edit coordinates if any not on land
sum(is.na(bioclim_all_sites_present_info))


#Save data for all sites and Bioclim 1-19
write.table(bioclim_all_sites_present_info, "Enviro/BioclimData_all_Sites_Present.txt", quote=F, row.names = F, col.names = T, sep="\t")


##Check for correlations among variables:
bioclim_all_sites_present_info
scaleenv<-as.data.frame(apply(data.matrix(bioclim_all_sites_present_info[,2:20]), 2, function(x) scale(x)))

pairs.panels(scaleenv, scale=T)

#Get correlations
correlation_mtrix <- cor(data.matrix(scaleenv))
diag(correlation_mtrix) <- NA

#Get max value 
max(abs(correlation_mtrix), na.rm=T)

apply(abs(correlation_mtrix), 1, max, na.rm=T)

#Remove Bio 17
correlation_mtrix_noBio17 <- correlation_mtrix[-17, -17]

max(abs(correlation_mtrix_noBio17), na.rm=T)
apply(abs(correlation_mtrix_noBio17), 1, max, na.rm=T)

#Remove Bio 19
dim(correlation_mtrix_noBio17)

correlation_mtrix_noBio17_19 <- correlation_mtrix_noBio17[-18, -18]
max(abs(correlation_mtrix_noBio17_19), na.rm=T)
apply(abs(correlation_mtrix_noBio17_19), 1, max, na.rm=T)


#Remove Bio 16
dim(correlation_mtrix_noBio17_19)
correlation_mtrix_noBio17_19_16 <- correlation_mtrix_noBio17_19[-16, -16]
max(abs(correlation_mtrix_noBio17_19_16), na.rm=T)
apply(abs(correlation_mtrix_noBio17_19_16), 1, max, na.rm=T)

#Remove Bio 14
correlation_mtrix_noBio17_19_16_14 <- correlation_mtrix_noBio17_19_16[-14, -14]
max(abs(correlation_mtrix_noBio17_19_16_14), na.rm=T)
apply(abs(correlation_mtrix_noBio17_19_16_14), 1, max, na.rm=T)

#remove Bio5
correlation_mtrix_noBio17_19_16_14_5 <- correlation_mtrix_noBio17_19_16_14[-5, -5]
max(abs(correlation_mtrix_noBio17_19_16_14_5), na.rm=T)
apply(abs(correlation_mtrix_noBio17_19_16_14_5), 1, max, na.rm=T)

#remove bio18
dim(correlation_mtrix_noBio17_19_16_14_5)
correlation_mtrix_noBio17_19_16_14_5_18 <- correlation_mtrix_noBio17_19_16_14_5[-14, -14]
max(abs(correlation_mtrix_noBio17_19_16_14_5_18), na.rm=T)
apply(abs(correlation_mtrix_noBio17_19_16_14_5_18), 1, max, na.rm=T)

#Remove bio12
correlation_mtrix_noBio17_19_16_14_5_18_12 <- correlation_mtrix_noBio17_19_16_14_5_18[-11, -11]
max(abs(correlation_mtrix_noBio17_19_16_14_5_18_12), na.rm=T)
apply(abs(correlation_mtrix_noBio17_19_16_14_5_18_12), 1, max, na.rm=T)


#Remove bio9
correlation_mtrix_noBio17_19_16_14_5_18_12_9 <- correlation_mtrix_noBio17_19_16_14_5_18_12[-8, -8]
max(abs(correlation_mtrix_noBio17_19_16_14_5_18_12_9), na.rm=T)
apply(abs(correlation_mtrix_noBio17_19_16_14_5_18_12_9), 1, max, na.rm=T)

#Remove bio1
correlation_mtrix_noBio17_19_16_14_5_18_12_9_1 <- correlation_mtrix_noBio17_19_16_14_5_18_12_9[-1, -1]
max(abs(correlation_mtrix_noBio17_19_16_14_5_18_12_9_1), na.rm=T)
apply(abs(correlation_mtrix_noBio17_19_16_14_5_18_12_9_1), 1, max, na.rm=T)

#Remove bio4
correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4 <- correlation_mtrix_noBio17_19_16_14_5_18_12_9_1[-3, -3]
max(abs(correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4), na.rm=T)
apply(abs(correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4), 1, max, na.rm=T)


#Remove bio7
correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4_7 <- correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4[-4, -4]
max(abs(correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4_7), na.rm=T)
apply(abs(correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4_7), 1, max, na.rm=T)

#Remove bio6
correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4_7_6 <- correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4_7[-3, -3]
max(abs(correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4_7_6), na.rm=T)
apply(abs(correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4_7_6), 1, max, na.rm=T)

#Remove bio3
correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4_7_6_3<- correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4_7_6[-2, -2]
max(abs(correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4_7_6_3), na.rm=T)
apply(abs(correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4_7_6_3), 1, max, na.rm=T)


uncorrelated_bioclim <- bioclim_all_sites_present_info[,c("V1",colnames(correlation_mtrix_noBio17_19_16_14_5_18_12_9_1_4_7_6_3))]
dim(uncorrelated_bioclim)
pairs.panels(uncorrelated_bioclim[,2:7], scale=T)

# all correlations below 0.40 -- pretty good?
write.table(uncorrelated_bioclim, "Enviro/Uncorrelated_EnviroData_below040.txt", quote = F, row.names = F, col.names = T, sep="\t")

#Scale enviromental variabels for RDA -- use unscaled in gradient forest
Uncorrelated_scaleenv<-as.data.frame(apply(data.matrix(uncorrelated_bioclim[,2:7]), 2, function(x) scale(x)))
Uncorrelated_scaleenv2 <- cbind("Code"=uncorrelated_bioclim$V1, Uncorrelated_scaleenv)
write.table(Uncorrelated_scaleenv2, "Enviro/Scaled_Uncorrelated_EnviroData_below040.txt", quote = F, row.names = F, col.names = T, sep="\t")

all_snps_allelefreq[1:10,1:10]
combined_snp_envir <- merge(uncorrelated_bioclim, as.data.frame(all_snps_allelefreq), by=1 )
combined_snp_envir_scaled <- merge(Uncorrelated_scaleenv2, as.data.frame(all_snps_allelefreq), by=1 )

# all correlations below 0.40 -- pretty good?
fwrite(combined_snp_envir, "Enviro/AlleleFreq_plusUncorrelated_EnviroData_below040.txt", quote = F, row.names = F, col.names = T, sep="\t")
fwrite(combined_snp_envir_scaled, "Enviro/AlleleFreq_plusUncorrelated_SCALED_EnviroData_below040.txt", quote = F, row.names = F, col.names = T, sep="\t")

combined_snp_envir_scaled[1:10,1:10]
